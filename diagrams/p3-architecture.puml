@startuml
title P3 - Integrated Architecture (Security + Data access)

skinparam componentStyle rectangle
skinparam shadowing false

actor "User" as U
actor "Admin" as A

rectangle "Client" {
  [React Frontend\n(Port 3000 / Azure Web App)] as FE
}

rectangle "Security (AWS)" {
  [AWS Cognito\nUser Pool + App Client\nGroups: admin/user\nClaim: custom:device_id] as COG
}

rectangle "Backend (Azure)" {
  [FastAPI API\n/ api/profile\n/ api/data\n/ api/devices\nJWT verification] as API
}

database "Azure Blob Storage\nContainer: processed\nlatest/ and by-timestamp/" as BLOB

rectangle "ETL (Azure)" {
  [Azure Data Factory\nMapping Data Flow\nCSV -> JSON\nOne JSON object per device] as ADF
}

rectangle "Monitoring / Logs" {
  [Azure App Service Logs\n(FastAPI)] as LOGS1
  [ADF Pipeline Run Logs] as LOGS2
}

U --> FE : Use app
A --> FE : Use app

FE --> COG : Sign-in (SDK)\nGet JWT (idToken)
FE --> API : Call API\nAuthorization: Bearer <JWT>

API --> COG : Verify JWT\n(JWKS / issuer/audience)
API --> BLOB : Read latest/<device>.json\nbased on role/device claim

ADF --> BLOB : Write processed JSON\n(latest + by-timestamp)

API --> LOGS1 : Auth/access logs
ADF --> LOGS2 : Execution logs

note right of API
Admin:
- can request any device_id
User:
- forced to custom:device_id
end note

@enduml
