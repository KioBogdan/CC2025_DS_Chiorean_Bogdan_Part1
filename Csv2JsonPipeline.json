{"$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"factoryName":{"type":"string","metadata":"Data Factory name"},"AzureBlobStorageCC":{"type":"string"}},"variables":{"factoryId":"[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"},"resources":[{"name":"[concat(parameters('factoryName'), '/Csv2JsonPipeline')]","type":"Microsoft.DataFactory/factories/pipelines","apiVersion":"2018-06-01","properties":{"activities":[{"name":"CentrDataFlow","type":"ExecuteDataFlow","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"dataflow":{"referenceName":"CentrDataFlow","type":"DataFlowReference","parameters":{"p_metric_column":{"value":"'@{pipeline().parameters.metric_column}'","type":"Expression"},"p_run_timestamp":{"value":"'@{pipeline().parameters.run_timestamp}'","type":"Expression"}},"datasetParameters":{"RawCsvDataset":{},"processedSink":{},"historySink":{}}},"staging":{},"compute":{"coreCount":8,"computeType":"General"},"traceLevel":"Fine"}}],"policy":{"elapsedTimeMetric":{}},"parameters":{"metric_column":{"type":"string"},"run_timestamp":{"type":"string","defaultValue":"@formatDateTime(utcNow(), 'yyyyMMdd-HHmmss')"}},"annotations":[],"lastPublishTime":"2025-12-11T22:39:42Z"},"dependsOn":["[concat(variables('factoryId'), '/dataflows/CentrDataFlow')]"]},{"name":"[concat(parameters('factoryName'), '/CentrDataFlow')]","type":"Microsoft.DataFactory/factories/dataflows","apiVersion":"2018-06-01","properties":{"type":"MappingDataFlow","typeProperties":{"sources":[{"dataset":{"referenceName":"RawCsvDataset","type":"DatasetReference"},"name":"RawCsvDataset"}],"sinks":[{"dataset":{"referenceName":"ProcessedJsonDataset","type":"DatasetReference"},"name":"processedSink"},{"dataset":{"referenceName":"HistoryJsonDataset","type":"DatasetReference"},"name":"historySink"}],"transformations":[{"name":"derivedColumn1"},{"name":"window1"},{"name":"derivedColumn2"}],"scriptLines":["parameters{","     p_metric_column as string,","     p_run_timestamp as string","}","source(output(","          device_id as string,","          timestamp as string,","          item_id as string,","          qty as string,","          unit_price as string,","          store as string","     ),","     allowSchemaDrift: true,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> RawCsvDataset","RawCsvDataset derive(time_window = toTimestamp(timestamp, 'yyyy-MM-dd'),","          metric_value = toDecimal(byName($p_metric_column)),","          metric_name = $p_metric_column,","          generation_timestamp = currentUTC()) ~> derivedColumn1","derivedColumn1 window(over(device_id,","          metric_name),","     asc(timestamp, true),","     records = collect(\r","    @(\r","        timestamp = time_window,\r","        value = metric_value\r","    )\r","),","          total_value = sum(metric_value),","          min_value = min(metric_value),","          max_value = max(metric_value),","          avg_value = avg(metric_value),","          start_ts = min(time_window),","          end_ts = max(time_window),","          gen_ts = max(generation_timestamp)) ~> window1","window1 derive(time_start_end = @(start=start_ts,","          end=end_ts),","          summary = @(total_value=total_value,","          min_value=min_value,","          max_value=max_value,","          avg_value=avg_value),","          latest_filename = concat('device-', device_id, '.json'),","          history_filename = concat('device-', device_id, '_', $p_run_timestamp, '.json')) ~> derivedColumn2","derivedColumn2 sink(allowSchemaDrift: true,","     validateSchema: false,","     rowUrlColumn:'latest_filename',","     truncate: true,","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true,","     saveOrder: 1) ~> processedSink","derivedColumn2 sink(allowSchemaDrift: true,","     validateSchema: false,","     rowUrlColumn:'history_filename',","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true,","     saveOrder: 1) ~> historySink"]}},"dependsOn":["[concat(variables('factoryId'), '/datasets/RawCsvDataset')]","[concat(variables('factoryId'), '/datasets/ProcessedJsonDataset')]","[concat(variables('factoryId'), '/datasets/HistoryJsonDataset')]"]},{"name":"[concat(parameters('factoryName'), '/RawCsvDataset')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('AzureBlobStorageCC')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobStorageLocation","container":"raw"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"device_id","type":"String"},{"name":"timestamp","type":"String"},{"name":"item_id","type":"String"},{"name":"qty","type":"String"},{"name":"unit_price","type":"String"},{"name":"store","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/ProcessedJsonDataset')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('AzureBlobStorageCC')]","type":"LinkedServiceReference"},"annotations":[],"type":"Json","typeProperties":{"location":{"type":"AzureBlobStorageLocation","folderPath":"latest","container":"processedv2"}},"schema":{}},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/HistoryJsonDataset')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('AzureBlobStorageCC')]","type":"LinkedServiceReference"},"annotations":[],"type":"Json","typeProperties":{"location":{"type":"AzureBlobStorageLocation","folderPath":"by-timestamp","container":"processedv2"}},"schema":{}},"dependsOn":[]}]}